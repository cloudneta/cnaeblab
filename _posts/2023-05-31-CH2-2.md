---
layout: post
title: 2장 실습 Amazon VPC CNI 구성 확인하기
subtitle: Amazon EKS에 구성된 Amazon CNI 구성을 확인합니다.
tags: [eks, 2장]
published: true
---
|목차|
|-----------|
|[1. 기본 네트워크 환경 확인](#1-기본-네트워크-환경-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;1.1. 네트워크 기본 정보 확인](#11-네트워크-기본-정보-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;1.2. 워커 노드의 네트워크 정보 확인](#12-워커-노드의-네트워크-정보-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;1.3. 테스트용 파드 생성 및 확인](#13-테스트용-파드-생성-및-확인)|
|[2. Amazon EKS 원클릭 배포 정보 확인](#2-amazon-eks-원클릭-배포-정보-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;2.1. 기본 정보 확인](#21-기본-정보-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;2.2. Amazon EKS 노드 정보 및 통신 확인](#22-amazon-eks-노드-정보-및-통신-확인)|
|[3. 실습 환경 삭제](#3-실습-환경-삭제)|

<br/>


## 1. 기본 네트워크 환경 확인

<br/>

이번 실습은 <span style='color:black; background-color:#FFDB58'>**Amazon EKS 원클릭 배포**</span> 환경에서 진행합니다.  
인프라 배포를 진행하지 않은 경우 [링크](https://cloudneta.github.io/cnaeblab/2023-06-01-CH2-1/)를 통해 배포 후 복귀 바랍니다.

<br/>

### 1.1. 네트워크 기본 정보 확인

Amazon VPC CNI 구성 환경에서 기본적인 네트워크 정보를 확인합니다.

<br/>

<span style='color:white; background-color:#404040'> **Daemonset 정보 확인** </span>  
{% highlight javascript linenos %}
// kube-system의 daemonset 확인
kubectl get daemonset -n kube-system

// vpc-cni 정보 확인
kubectl describe daemonset aws-node -n kube-system | grep Image | cut -d "/" -f 2

// kube-proxy config 확인
kubectl describe cm -n kube-system kube-proxy-config
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **워커 노드 IP와 파드 IP 확인** </span>  
{% highlight javascript linenos %}
// 워커 노드 IP 확인
aws ec2 describe-instances --query "Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key=='Name']|[0].Value,Status:State.Name}" --filters Name=instance-state-name,Values=running --output table

// 파드 IP 확인
kubectl get pod -n kube-system -o=custom-columns=NAME:.metadata.name,IP:.status.podIP,STATUS:.status.phase
{% endhighlight %}

<br/><br/>


### 1.2. 워커 노드의 네트워크 정보 확인

<br/>

<span style='color:white; background-color:#404040'> **워커 노드에 사용할 도구 설치** </span>  
{% highlight javascript linenos %}
//  3대의 워커노드의 Private IP 주소 변수 저장
N1=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2a -o jsonpath={.items[0].status.addresses[0].address})

N2=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2b -o jsonpath={.items[0].status.addresses[0].address})

N3=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2c -o jsonpath={.items[0].status.addresses[0].address})

// 3대의 워커 노드에 사용할 도구 설치
ssh ec2-user@$N1 sudo yum install links tree jq tcpdump -y

ssh ec2-user@$N2 sudo yum install links tree jq tcpdump -y

ssh ec2-user@$N3 sudo yum install links tree jq tcpdump -y
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **워커 노드에 네트워크 정보 확인** </span>  
{% highlight javascript linenos %}
// 워커 노드 1에서 vpc-cni 정보 확인
ssh ec2-user@$N1 tree /var/log/aws-routed-eni

ssh ec2-user@$N1 cat /var/log/aws-routed-eni/plugin.log | jq

ssh ec2-user@$N1 cat /var/log/aws-routed-eni/ipamd.log | jq

// 워커 노드 1에서 네트워크 정보 확인
ssh ec2-user@$N1 sudo ip -br -c addr

ssh ec2-user@$N1 sudo ip -c route

// coreDNS 파드 정보 확인
kubectl get pod -n kube-system -l k8s-app=kube-dns -owide
{% endhighlight %}

<br/><br/>


### 1.3. 테스트용 파드 생성 및 확인

테스트용으로 netshoot 파드를 3대 생성하고 관련 정보를 확인합니다.

<br/>

<span style='color:white; background-color:#404040'> **신규 터미널 3개에 워커 노드 모니터링 수행** </span>  
{% highlight javascript linenos %}
// 워커 노드1의 모니터링
ssh ec2-user@$N1

watch -d "ip link | egrep 'eth|eni' ;echo;echo "[ROUTE TABLE]"; route -n | grep eni"

// 워커 노드2의 모니터링
ssh ec2-user@$N2

watch -d "ip link | egrep 'eth|eni' ;echo;echo "[ROUTE TABLE]"; route -n | grep eni"

// 워커 노드3의 모니터링
ssh ec2-user@$N3

watch -d "ip link | egrep 'eth|eni' ;echo;echo "[ROUTE TABLE]"; route -n | grep eni"
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **테스트용 netshoot 파드 3대 생성** </span>  
{% highlight javascript linenos %}
cat <<EOF | kubectl create -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netshoot-pod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: netshoot-pod
  template:
    metadata:
      labels:
        app: netshoot-pod
    spec:
      containers:
      - name: netshoot-pod
        image: nicolaka/netshoot
        command: ["tail"]
        args: ["-f", "/dev/null"]
      terminationGracePeriodSeconds: 0
EOF
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **테스트용 파드 이름 변수 저장** </span>  
// 파드 이름을 변수에 저장
{% highlight javascript linenos %}
PODNAME1=$(kubectl get pod -l app=netshoot-pod -o jsonpath={.items[0].metadata.name})

PODNAME2=$(kubectl get pod -l app=netshoot-pod -o jsonpath={.items[1].metadata.name})

PODNAME3=$(kubectl get pod -l app=netshoot-pod -o jsonpath={.items[2].metadata.name})
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **테스트용 파드 exec 접속 후 네트워크 정보 확인** </span>  
// 테스트용 파드 1에 zsh 접근
kubectl exec -it $PODNAME1 -- zsh

// 테스트용 파드에 인터페이스 및 IP 확인
kubectl exec -it $PODNAME1 -- ip -br -c addr

kubectl exec -it $PODNAME2 -- ip -br -c addr

kubectl exec -it $PODNAME3 -- ip -br -c addr

// 테스트용 파드에서 ping 테스트
kubectl exec -it $PODNAME1 -- ping -c 1 POD-2_IP

kubectl exec -it $PODNAME1 -- ping -c 1 POD-3_IP

{% endhighlight %}

<br/>

---

<br/>

## 2. Amazon EKS 원클릭 배포 정보 확인

<br/>

AWS CloudFormation 스택의 출력 탭에서 eksctlhost의 퍼블릭 IP를 확인합니다.  
해당 IP로 EKS 관리용 인스턴스(`myeks-host`)에 SSH로 접속하고 아래 명령어를 통해 정보를 확인합니다.

<br/>

### 2.1. 기본 정보 확인

설치된 Amazon EKS 클러스터 관련 정보들을 확인합니다.

<br/>

<span style='color:white; background-color:#404040'> **Default Namespace로 적용** </span>  
{% highlight javascript linenos %}
// krew 플러그인 확인
kubectl krew list

// Default Namespace로 위치 변경
kubectl ns default
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **선언된 환경 변수 확인** </span>  
{% highlight javascript linenos %}
// 미리 정의한 환경 변수 확인
export | egrep 'ACCOUNT|AWS_|CLUSTER|KUBERNETES|VPC|Subnet' | egrep -v 'SECRET|KEY'
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **Amazon EKS 클러스터 설치 확인** </span>  
{% highlight javascript linenos %}
// 설치된 EKS 클러스터 확인
kubectl cluster-info

eksctl get cluster

// 설치된 EKS 노드 그룹 확인
eksctl get nodegroup --cluster $CLUSTER_NAME

// 워커 노드 정보 확인
kubectl get node --label-columns=node.kubernetes.io/instance-type,eks.amazonaws.com/capacityType,topology.kubernetes.io/zone
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **Amazon EKS 클러스터 인증 정보 확인** </span>  
{% highlight javascript linenos %}
// kubeconfig 정보 확인
cat /root/.kube/config | yh

// ctx 확인
kubectl ctx
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **Amazon EKS Add-on 정보 확인** </span>  
{% highlight javascript linenos %}
// 설치된 Add-on 정보 확인
eksctl get addon --cluster $CLUSTER_NAME

// 쿠버네티스 버전별 지원 Add-on 확인(ex_1.26)
aws eks describe-addon-versions --kubernetes-version 1.26  --query 'addons[].{MarketplaceProductUrl: marketplaceInformation.productUrl, Name: addonName, Owner: owner Publisher: publisher, Type: type}' --output table

eksctl utils describe-addon-versions --kubernetes-version 1.26 | grep AddonName
{% endhighlight %}

<br/>



### 2.2. Amazon EKS 노드 정보 및 통신 확인

생성된 Amazon EKS 워커 노드에 대해 통신 환경을 구성하고, PING 테스트와 SSH 접근을 수행합니다.

<br/>

<span style='color:white; background-color:#404040'> **워커 노드의 Private IP 확인 및 변수 선언** </span>

{% highlight javascript linenos %}
// EC2 인스턴스 정보 확인
aws ec2 describe-instances --query "Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key=='Name']|[0].Value,Status:State.Name}" --filters Name=instance-state-name,Values=running --output table

//  3대의 워커노드의 Private IP 주소 변수 저장
N1=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2a -o jsonpath={.items[0].status.addresses[0].address})

N2=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2b -o jsonpath={.items[0].status.addresses[0].address})

N3=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2c -o jsonpath={.items[0].status.addresses[0].address})

// 3대의 워커노드의 Private IP 주소 전역 변수로 선언 및 확인
echo "export N1=$N1" >> /etc/profile

echo "export N2=$N2" >> /etc/profile

echo "export N3=$N3" >> /etc/profile

echo $N1, $N2, $N3
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **노드 그룹에 대한 보안 그룹 확인 및 변수 선언** </span>

{% highlight javascript linenos %}
// 보안 그룹 확인
aws ec2 describe-security-groups \
  --query 'SecurityGroups[*].[GroupId, GroupName]' \
  --output text

// 노드 그룹에 대한 보안 그룹 ID만 필터링
aws ec2 describe-security-groups \
  --filters Name=group-name,Values=*ng1* \
  --query "SecurityGroups[*].[GroupId]" \
  --output text

// 노드 그룹에 대한 보안 그룹 ID 변수 선언
NGSGID=$(aws ec2 describe-security-groups --filters Name=group-name,Values=*ng1* --query "SecurityGroups[*].[GroupId]" --output text)

echo $NGSGID

// 노드 그룹에 대한 보안 그룹에 my-eks에서 접속 가능한 규칙 추가
aws ec2 authorize-security-group-ingress \
  --group-id $NGSGID \
  --protocol '-1' \
  --cidr 192.168.1.100/32
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **myeks에서 워커 노드로 통신 확인** </span>

{% highlight javascript linenos %}
// 워커 노드로 PING 테스트
ping -c 2 $N1

ping -c 2 $N2

ping -c 2 $N3

// 워커 노드로 SSH 접속
ssh ec2-user@$N1 
exit

ssh ec2-user@$N2
exit

ssh ec2-user@$N3
exit

ssh -o ec2-user@$N1 hostname

ssh -o ec2-user@$N2 hostname

ssh -o ec2-user@$N3 hostname
{% endhighlight %}

<br/>

---

<br/>

## 3. 실습 환경 삭제

<br/>

Amazon EKS 원클릭을 통해 배포된 모든 자원을 삭제합니다.

<br/>

<span style='color:white; background-color:#404040'> **Amazon EKS 원클릭 배포의 삭제** </span>

{% highlight javascript linenos %}
// Amazon EKS 원클릭 배포의 삭제
eksctl delete cluster --name $CLUSTER_NAME \
  && aws cloudformation delete-stack --stack-name $CLUSTER_NAME
{% endhighlight %}

{: .box-warning}
**Warning:** Amazon EKS 원클릭 배포의 삭제는 약 15분 정도 소요됩니다. 삭제가 완료될 때 까지 SSH 연결 세션을 유지합니다.

<br/>

---

<br/>

여기까지 2장의 Amazon EKS 원클릭 배포 실습을 마칩니다.  
수고하셨습니다 :)

<br/><br/>
