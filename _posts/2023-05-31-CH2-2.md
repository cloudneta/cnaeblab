---
layout: post
title: 2장 실습 Amazon VPC CNI 구성 확인하기
subtitle: Amazon EKS에 구성된 Amazon CNI 구성을 확인합니다.
tags: [eks, 2장]
published: true
---
|목차|
|-----------|
|[1. 기본 네트워크 환경 확인](#1-기본-네트워크-환경-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;1.1. 네트워크 기본 정보 확인](#11-네트워크-기본-정보-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;1.2. 워커 노드의 네트워크 정보 확인](#12-워커-노드의-네트워크-정보-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;1.3. 테스트용 파드 생성 및 확인](#13-테스트용-파드-생성-및-확인)|
|[2. Amazon EKS 원클릭 배포 정보 확인](#2-amazon-eks-원클릭-배포-정보-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;2.1. 기본 정보 확인](#21-기본-정보-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;2.2. Amazon EKS 노드 정보 및 통신 확인](#22-amazon-eks-노드-정보-및-통신-확인)|
|[3. 실습 환경 삭제](#3-실습-환경-삭제)|

<br/>


## 1. 기본 네트워크 환경 확인

<br/>

이번 실습은 <span style='color:black; background-color:#FFDB58'>**Amazon EKS 원클릭 배포**</span> 환경에서 진행합니다.  
인프라 배포를 진행하지 않은 경우 [링크](https://cloudneta.github.io/cnaeblab/2023-06-01-CH2-1/){:target="_blank"}를 통해 배포 후 복귀 바랍니다.

<br/>

### 1.1. 네트워크 기본 정보 확인

Amazon VPC CNI 구성 환경에서 기본적인 네트워크 정보를 확인합니다.

<br/>

<span style='color:white; background-color:#404040'> **Daemonset 정보 확인** </span>  
{% highlight javascript linenos %}
// kube-system의 daemonset 확인
kubectl get daemonset -n kube-system

// vpc-cni 정보 확인
kubectl describe daemonset aws-node -n kube-system | grep Image | cut -d "/" -f 2

// kube-proxy config 확인
kubectl describe cm -n kube-system kube-proxy-config
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **워커 노드 IP와 파드 IP 확인** </span>  
{% highlight javascript linenos %}
// 워커 노드 IP 확인
aws ec2 describe-instances --query "Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key=='Name']|[0].Value,Status:State.Name}" --filters Name=instance-state-name,Values=running --output table

// 파드 IP 확인
kubectl get pod -n kube-system -o=custom-columns=NAME:.metadata.name,IP:.status.podIP,STATUS:.status.phase
{% endhighlight %}

<br/><br/>


### 1.2. 워커 노드의 네트워크 정보 확인

<br/>

<span style='color:white; background-color:#404040'> **워커 노드에 사용할 도구 설치** </span>  
{% highlight javascript linenos %}
//  3대의 워커노드의 Private IP 주소 변수 저장
N1=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2a -o jsonpath={.items[0].status.addresses[0].address})
N2=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2b -o jsonpath={.items[0].status.addresses[0].address})
N3=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2c -o jsonpath={.items[0].status.addresses[0].address})
echo "export N1=$N1" >> /etc/profile
echo "export N2=$N2" >> /etc/profile
echo "export N3=$N3" >> /etc/profile
echo $N1, $N2, $N3

// 3대의 워커 노드에 사용할 도구 설치
ssh ec2-user@$N1 sudo yum install links tree jq tcpdump -y

ssh ec2-user@$N2 sudo yum install links tree jq tcpdump -y

ssh ec2-user@$N3 sudo yum install links tree jq tcpdump -y
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **워커 노드에 네트워크 정보 확인** </span>  
{% highlight javascript linenos %}
// 워커 노드 1에서 vpc-cni 정보 확인
ssh ec2-user@$N1 tree /var/log/aws-routed-eni

ssh ec2-user@$N1 cat /var/log/aws-routed-eni/plugin.log | jq

ssh ec2-user@$N1 cat /var/log/aws-routed-eni/ipamd.log | jq

// 워커 노드 1에서 네트워크 정보 확인
ssh ec2-user@$N1 sudo ip -br -c addr

ssh ec2-user@$N1 sudo ip -c route

// coreDNS 파드 정보 확인
kubectl get pod -n kube-system -l k8s-app=kube-dns -owide
{% endhighlight %}

<br/><br/>


### 1.3. 테스트용 파드 생성 및 확인

테스트용으로 netshoot 파드를 3대 생성하고 관련 정보를 확인합니다.

<br/>

<span style='color:white; background-color:#404040'> **신규 터미널 3개에 워커 노드 모니터링 수행** </span>  
{% highlight javascript linenos %}
// 워커 노드1의 모니터링
ssh ec2-user@$N1

watch -d "ip link | egrep 'eth|eni' ;echo;echo "[ROUTE TABLE]"; route -n | grep eni"

// 워커 노드2의 모니터링
ssh ec2-user@$N2

watch -d "ip link | egrep 'eth|eni' ;echo;echo "[ROUTE TABLE]"; route -n | grep eni"

// 워커 노드3의 모니터링
ssh ec2-user@$N3

watch -d "ip link | egrep 'eth|eni' ;echo;echo "[ROUTE TABLE]"; route -n | grep eni"
{% endhighlight %}

{: .box-note}
**Note:** 신규 터미널을 3개 추가하고 작업용 인스턴스에 진입한 후 워커 노드 1, 2, 3으로 각각 SSH 접근을 합니다.

<br/>

<span style='color:white; background-color:#404040'> **테스트용 netshoot 파드 3대 생성** </span>  

테스트용 파드는 간단한 디버깅이나 테스트를 수행하는 용도의 netshoot이라는 컨테이너 이미지를 사용합니다. [참고 링크: nicolaka/netshoot](https://github.com/nicolaka/netshoot){:target="_blank"}

{% highlight javascript linenos %}
cat <<EOF | kubectl create -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netshoot-pod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: netshoot-pod
  template:
    metadata:
      labels:
        app: netshoot-pod
    spec:
      containers:
      - name: netshoot-pod
        image: nicolaka/netshoot
        command: ["tail"]
        args: ["-f", "/dev/null"]
      terminationGracePeriodSeconds: 0
EOF
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **테스트용 파드 이름 변수 저장** </span>  
{% highlight javascript linenos %}
// 파드 이름을 변수에 저장
PODNAME1=$(kubectl get pod -l app=netshoot-pod -o jsonpath={.items[1].metadata.name})

PODNAME2=$(kubectl get pod -l app=netshoot-pod -o jsonpath={.items[0].metadata.name})

PODNAME3=$(kubectl get pod -l app=netshoot-pod -o jsonpath={.items[2].metadata.name})
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **테스트용 파드 exec 접속 후 네트워크 정보 확인** </span>  
{% highlight javascript linenos %}
// 테스트용 파드 1에 zsh 접근
kubectl exec -it $PODNAME1 -- zsh

// 테스트용 파드에 인터페이스 및 IP 확인
kubectl exec -it $PODNAME1 -- ip -br -c addr

kubectl exec -it $PODNAME2 -- ip -br -c addr

kubectl exec -it $PODNAME3 -- ip -br -c addr

// 테스트용 파드 1에서 다른 파드로 ping 테스트
kubectl exec -it $PODNAME1 -- ping -c 2 [POD-2_IP]

kubectl exec -it $PODNAME1 -- ping -c 2 [POD-3_IP]
{% endhighlight %}

<br/>

---

<br/>

## 2. 파드 통신 확인

<br/>

앞서 생성한 파드에서 다른 노드에 위치한 파드로 통신하거나 외부 인터넷 구간으로 통신할 때 동작을 실습으로 확인합니다.

<br/>

### 2.1. 노드 간 파드 통신

<br/>

<span style='color:white; background-color:#404040'> **파드 IP 변수 지정** </span>  
{% highlight javascript linenos %}
// 생성된 각 파드의 IP 주소를 변수로 지정
PODIP1=$(kubectl get pod -l app=netshoot-pod -o jsonpath={.items[1].status.podIP})

PODIP2=$(kubectl get pod -l app=netshoot-pod -o jsonpath={.items[0].status.podIP})

PODIP3=$(kubectl get pod -l app=netshoot-pod -o jsonpath={.items[2].status.podIP})
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **신규 터미널 3개에 tcpdump 수행** </span>  
{% highlight javascript linenos %}
// 워커 노드1의 모든 인터페이스에 tcpdump
ssh ec2-user@$N1

sudo tcpdump -i any -nn icmp

// 워커 노드1의 모든 인터페이스에 tcpdump
ssh ec2-user@$N2

sudo tcpdump -i any -nn icmp

// 워커 노드1의 모든 인터페이스에 tcpdump
ssh ec2-user@$N3

sudo tcpdump -i any -nn icmp
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **파드 간 ping 테스트** </span>  
{% highlight javascript linenos %}
// 파드1에서 파드2로 ping
kubectl exec -it $PODNAME1 -- ping -c 2 $PODIP2

// 파드1에서 파드3으로 ping
kubectl exec -it $PODNAME1 -- ping -c 2 $PODIP3

// 파드2에서 파드3으로 ping
kubectl exec -it $PODNAME2 -- ping -c 2 $PODIP3
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **파드와 노드의 라우팅 확인** </span>  
{% highlight javascript linenos %}
// 파드 1에서 라우팅 확인
kubectl exec -it $PODNAME1 -- ip -br addr

kubectl exec -it $PODNAME1 -- ip route show table main

// 워커 노드 1에서 라우팅 확인
ssh ec2-user@$N1 sudo ip route show table main
{% endhighlight %}

<br/>


### 2.2. 파드에서 외부 인터넷 통신 확인


<br/>

<span style='color:white; background-color:#404040'> **신규 터미널에 tcpdump 수행** </span>

{% highlight javascript linenos %}
// 워커 노드1의 모든 인터페이스에 tcpdump
ssh ec2-user@$N1

sudo tcpdump -i any -nn icmp
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **파드 1에서 외부 인터넷 통신** </span>

{% highlight javascript linenos %}
// google.com으로 ping
kubectl exec -it $PODNAME1 -- ping -c 1 www.google.com
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **파드와 워커 노드의 공인 IP 확인** </span>

{% highlight javascript linenos %}
// 파드 1의 공인 IP 주소 확인
kubectl exec -it $PODNAME1 -- curl -s ipinfo.io/ip ; echo

// 워커 노드 1의 공인 IP 주소 확인
ssh ec2-user@$N1 curl -s ipinfo.io/ip ; echo
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **워커 노드 1의 NAT 테이블 확인** </span>

{% highlight javascript linenos %}
// 워커 노드 1에서 NAT 테이블 확인
ssh ec2-user@$N1 sudo iptables -L -n -v -t nat

// 워커 노드 1에서 NAT Rule List 확인
ssh ec2-user@$N1 sudo iptables -t nat -S

ssh ec2-user@$N1 sudo iptables -t nat -S | grep 'A AWS-SNAT-CHAIN'
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **신규 터미널에 모니터링 수행** </span>

{% highlight javascript linenos %}
// 워커 노드 1에 SSH 접근
ssh ec2-user@$N1

// iptables 카운팅 값 초기화
sudo iptables -t filter --zero; sudo iptables -t nat --zero; sudo iptables -t mangle --zero; sudo iptables -t raw --zero

// iptables의 AWS-SNAT-CHAIN 모니터링
watch -d 'sudo iptables -v --numeric --table nat --list AWS-SNAT-CHAIN-0; echo ; sudo iptables -v --numeric --table nat --list AWS-SNAT-CHAIN-1; echo ; sudo iptables -v --numeric --table nat --list KUBE-POSTROUTING'

// conntrack 정보 모니터링
watch -d 'sudo conntrack -L -n |grep -v '169.254.169''
{% endhighlight %}

<br/>

### 2.3. 테스트용 파드 삭제


<br/>

<span style='color:white; background-color:#404040'> **테스트용 파드 삭제** </span>

{% highlight javascript linenos %}
kubectl delete deploy netshoot-pod
{% endhighlight %}

<br/>

---

## 3. 최대 파드 생성 확인

<br/>

앞선 실습 환경에서 다수의 파드를 생성하여 최대 파드 생성 개수를 확인합니다.

<br/>

### 3.1. kube-ops-view 설치

실습의 이해를 돕기 위해 [kube-ops-view](https://codeberg.org/hjacobs/kube-ops-view){:target="_blank"}라는 가시성 도구를 설치합니다.  
해당 도구를 통해 워커 노드에 구성된 파드 정보를 쉽게 확인할 수 있습니다.

<br/>













<br/>

---

## 4. 실습 환경 삭제

<br/>

Amazon EKS 원클릭을 통해 배포된 모든 자원을 삭제합니다.

<br/>

<span style='color:white; background-color:#404040'> **Amazon EKS 원클릭 배포의 삭제** </span>

{% highlight javascript linenos %}
// Amazon EKS 원클릭 배포의 삭제
eksctl delete cluster --name $CLUSTER_NAME \
  && aws cloudformation delete-stack --stack-name $CLUSTER_NAME
{% endhighlight %}

{: .box-warning}
**Warning:** Amazon EKS 원클릭 배포의 삭제는 약 15분 정도 소요됩니다. 삭제가 완료될 때 까지 SSH 연결 세션을 유지합니다.

<br/>

---

<br/>

여기까지 2장의 Amazon EKS 원클릭 배포 실습을 마칩니다.  
수고하셨습니다 :)

<br/><br/>
