---
layout: post
title: 4장 실습 프로메테우스와 그라파나 구성하기
subtitle: Amazon EKS 환경에서 프로메테우스와 그라파나를 구성하는 실습입니다.
tags: [eks, 4장]
published: true
---
|목차|
|-----------|
|[1. 프로메테우스 스택 설치](#1-프로메테우스-스택-설치)|
|[&nbsp;&nbsp;&nbsp;&nbsp;1.1. 프로메테우스 스택 설치](#11-프로메테우스-스택-설치)|
|[&nbsp;&nbsp;&nbsp;&nbsp;1.2. 프로메테우스 설치 확인](#12-프로메테우스-설치-확인)|
|[2. 프로메테우스 기본 사용](#2-프로메테우스-기본-사용)|
|[&nbsp;&nbsp;&nbsp;&nbsp;2.1. 모니터링 대상 확인](#21-모니터링-대상-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;2.2. 프로메테우스 ingress 도메인 접속 및 확인](#22-프로메테우스-ingress-도메인-접속-및-확인)|
|[3. 그라파나 대시보드 사용](#3-그라파나-대시보드-사용)|
|[&nbsp;&nbsp;&nbsp;&nbsp;3.1. 그라파나 정보 확인](#31-그라파나-정보-확인)|
|[&nbsp;&nbsp;&nbsp;&nbsp;3.2. 그라파나 대시보드 사용](#32-그라파나-대시보드-사용)|
|[4. 애플리케이션 모니터링 설정 및 대시보드 추가](#3-애플리케이션-모니터링-설정-및-대시보드-추가)|
|[&nbsp;&nbsp;&nbsp;&nbsp;4.1. NGINX 웹 서버 배포](#41-nginx-웹-서버-배포)|
|[&nbsp;&nbsp;&nbsp;&nbsp;4.2. NGINX 모니터링 대시보드 추가](#42-nginx-모니터링-대시보드-추가)|
|[&nbsp;&nbsp;&nbsp;&nbsp;4.3. 실습 자원 삭제](#43-실습-자원-삭제)|

<br/>

## 1. 프로메테우스 스택 설치

<br/>

이번 실습은 <span style='color:black; background-color:#FFDB58'>**4장 Amazon EKS 원클릭 배포**</span> 환경에서 진행합니다.  
인프라 배포를 진행하지 않은 경우 [링크](https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/new?stackName=myeks&templateURL=https:%2F%2Finflearnaeb.s3.ap-northeast-2.amazonaws.com%2Feks-oneclick3.yaml){:target="_blank"}를 통해 배포 후 복귀 바랍니다.  
그리고 새롭게 인프라를 배포하면 아래 기본 설정 명령을 입력 후 진행 바랍니다.

<details>
<summary><span style='color:orange'>기본 설정 명령어</span></summary>
<div markdown="1">

<br/>

<span style='color:white; background-color:#404040'> **Default 네임 스페이스 변경** </span>  
{% highlight javascript linenos %}
kubectl ns default
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **워커 노드의 IP 변수 선언** </span>  
{% highlight javascript linenos %}
N1=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2a -o jsonpath={.items[0].status.addresses[0].address})

N2=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2b -o jsonpath={.items[0].status.addresses[0].address})

N3=$(kubectl get node --label-columns=topology.kubernetes.io/zone --selector=topology.kubernetes.io/zone=ap-northeast-2c -o jsonpath={.items[0].status.addresses[0].address})

echo "export N1=$N1" >> /etc/profile

echo "export N2=$N2" >> /etc/profile

echo "export N3=$N3" >> /etc/profile
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **노드에 SSH 접근** </span>  
{% highlight javascript linenos %}
for node in $N1 $N2 $N3; do ssh ec2-user@$node hostname; done
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **AWS Load Balancer Controller 설치** </span>  
{% highlight javascript linenos %}
helm repo add eks https://aws.github.io/eks-charts

helm repo update

helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set clusterName=$CLUSTER_NAME \
  --set serviceAccount.create=false \
  --set serviceAccount.name=aws-load-balancer-controller
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **ExternalDNS 설치** </span>  
{% highlight javascript linenos %}
// 자신의 도메인 주소로 설정
MyDomain=<자신의 도메인>

MyDnsHostedZoneId=$(aws route53 list-hosted-zones-by-name --dns-name "${MyDomain}." --query "HostedZones[0].Id" --output text)

echo $MyDomain, $MyDnzHostedZoneId

curl -s -O https://raw.githubusercontent.com/cloudneta/cnaeblab/master/_data/externaldns.yaml

MyDomain=$MyDomain MyDnsHostedZoneId=$MyDnsHostedZoneId envsubst < externaldns.yaml | kubectl apply -f -
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **kube-ops-view 설치** </span>  
{% highlight javascript linenos %}
helm repo add geek-cookbook https://geek-cookbook.github.io/charts/

helm install kube-ops-view geek-cookbook/kube-ops-view --version 1.2.2 --set env.TZ="Asia/Seoul" --namespace kube-system

kubectl patch svc -n kube-system kube-ops-view -p '{"spec":{"type":"LoadBalancer"}}'

kubectl annotate service kube-ops-view -n kube-system "external-dns.alpha.kubernetes.io/hostname=kubeopsview.$MyDomain"

echo -e "Kube Ops View URL = http://kubeopsview.$MyDomain:8080/#scale=1.5"
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **StorageClass 생성** </span>  
{% highlight javascript linenos %}
cat <<EOT > gp3-sc.yaml
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: gp3
allowVolumeExpansion: true
provisioner: ebs.csi.aws.com
volumeBindingMode: WaitForFirstConsumer
parameters:
  type: gp3
  allowAutoIOPSPerGBIncrease: 'true'
  encrypted: 'true'
EOT

kubectl apply -f gp3-sc.yaml
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **ACM 인증서 변수 선언** </span>  
{% highlight javascript linenos %}
CERT_ARN=`aws acm list-certificates --query 'CertificateSummaryList[].CertificateArn[]' --output text`; echo $CERT_ARN
{% endhighlight %}

<br/>

</div>
</details>

<br/>

### 1.1. 프로메테우스 스택 설치

<br/>

<span style='color:white; background-color:#404040'> **신규터미널 - 네임 스페이스 추가 및 모니터링** </span>  
{% highlight javascript linenos %}
// monitoring 네임 스페이스 추가
kubectl create ns monitoring

kubectl get ns

// 신규 터미널 - pod, svc, ingress, pv, pvc 모니터링
watch kubectl get pod,svc,ingress,pv,pvc -n monitoring
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **helm repo 추가** </span>  
{% highlight javascript linenos %}
// helm chart repository 추가
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **프로메테우스 스택 설치** </span>  
{% highlight javascript linenos %}
// 파라미터 파일 다운로드 및 확인
curl -s -O https://raw.githubusercontent.com/cloudneta/cnaeblab/master/_data/monitor-values.yaml

cat monitor-values.yaml | yh

// 환경 변수 선언
export MyDomain=$MyDomain CERT_ARN=$CERT_ARN

// 프로메테우스 스택 배포
envsubst < monitor-values.yaml | helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack --version 45.27.2 \
  --set prometheus.prometheusSpec.scrapeInterval='15s' \
  --set prometheus.prometheusSpec.evaluationInterval='15s' \
  -f - --namespace monitoring
{% endhighlight %}

<br/><br/>


### 1.2. 프로메테우스 설치 확인

<br/>

<span style='color:white; background-color:#404040'> **helm list와 설치된 모든 자원 확인** </span>  
{% highlight javascript linenos %}
// monitoring 네임 스페이스에 helm list 확인
helm list -n monitoring

// monitoring 네임 스페이스에 모든 자원 확인
kubectl get-all -n monitoring
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **sts, ds, deloy 확인** </span>  
{% highlight javascript linenos %}
// monitoring 네임 스페이스에 sts, ds, deploy 확인
kubectl get sts,ds,deploy -n monitoring

// statefulset 상세 정보
kubectl describe sts -n monitoring

// daemonset 상세 정보
kubectl describe ds -n monitoring
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **crd, servicemonitors, targetgroupbindings 확인** </span>  
{% highlight javascript linenos %}
// monitoring 네임 스페이스에 sts, ds, deploy 확인
kubectl get crd | grep monitoring

kubectl get servicemonitors -n monitoring

kubectl get targetgroupbindings -n monitoring
{% endhighlight %}

<br/>


<br/>

---

<br/>

## 2. 프로메테우스 기본 사용

<br/>

### 2.1. 모니터링 대상 확인

<br/>

<span style='color:white; background-color:#404040'> **node-exporter 확인** </span>  
{% highlight javascript linenos %}
// node-expoter의 서비스와 엔드포인트 확인
kubectl get svc,ep -n monitoring kube-prometheus-stack-prometheus-node-exporter
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **모니터링 대상별 /metrics 확인** </span>  
{% highlight javascript linenos %}
// node-export - 노드에서 localhost로 9100 포트에 /metrics 접속
ssh ec2-user@$N1 curl -s localhost:9100/metrics | tail

// kube-proxy - 노드에서 localhost로 10249 포트에 /metrics 접속
ssh ec2-user@$N1 curl -s localhost:10249/metrics | tail
{% endhighlight %}

<br/>


### 2.2. 프로메테우스 ingress 도메인 접속 및 확인


<br/>

<span style='color:white; background-color:#404040'> **프로메테우스 ingress 정보 확인** </span>

{% highlight javascript linenos %}
// 프로메테우스 ingress 정보 확인
kubectl get ingress -n monitoring kube-prometheus-stack-prometheus

kubectl describe ingress -n monitoring kube-prometheus-stack-prometheus

// 프로메테우스 ingress 도메인으로 웹 접속
echo -e "Prometheus Web URL = https://prometheus.$MyDomain"
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **프로메테우스 상단 메뉴** </span>

1. 경고(Alert) : 사전에 정의한 시스템 경고 정책(Prometheus Rules)에 대한 상황  
2. 그래프(Graph) : 프로메테우스 자체 검색 언어 PromQL을 이용하여 메트릭 정보를 조회 -> 단순한 그래프 형태 조회  
3. 상태(Status) : 경고 메시지 정책(Rules), 모니터링 대상(Targets) 등 다양한 프로메테우스 설정 내역을 확인  
4. 도움말(Help)

<br/>

<span style='color:white; background-color:#404040'> **프로메테우스 설정 확인** </span>

{% highlight javascript linenos %}
// 프로메테우스 설정 파일 확인
kubectl exec -it -n monitoring sts/prometheus-kube-prometheus-stack-prometheus \
  -- cat /etc/prometheus/config_out/prometheus.env.yaml

// 프로메테우스 설정에서 job_name 확인
kubectl exec -it -n monitoring sts/prometheus-kube-prometheus-stack-prometheus \
  -- cat /etc/prometheus/config_out/prometheus.env.yaml | grep job_name:
  
// 프로메테우스 설정에서 node-export 확인
kubectl exec -it -n monitoring sts/prometheus-kube-prometheus-stack-prometheus \
  -- cat /etc/prometheus/config_out/prometheus.env.yaml | grep node-exporter/ -A 9

// 엔드포인트 확인
kubectl get ep -n monitoring;  kubectl get ep -n kube-system
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **PromQL 예시** </span>

{% highlight javascript linenos %}
// 전체 클러스터 노드의 CPU 사용량 평균
1- avg(rate(node_cpu_seconds_total{mode="idle"}[1m]))

// api-server 상주 메모리 평균
avg(process_resident_memory_bytes{job="apiserver"})

// node-export 스크랩 기간
scrape_duration_seconds{job="node-exporter"}
{% endhighlight %}

<br/>

---

<br/>

## 3. 그라파나 대시보드 사용

<br/>

### 3.1. 그라파나 정보 확인

<br/>

<span style='color:white; background-color:#404040'> **Application 로그 소스** </span>  
{% highlight javascript linenos %}
// application 로그 소스 확인
for node in $N1 $N2 $N3; do echo ">>>>> $node <<<<<"; \
ssh ec2-user@$node sudo tree /var/log/containers; echo; done

for node in $N1 $N2 $N3; do echo ">>>>> $node <<<<<"; \
ssh ec2-user@$node sudo tree /var/log/pods; echo; done
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **Host 로그 소스** </span>
{% highlight javascript linenos %}
// host 로그 소스 (Logs from /var/log/dmesg, /var/log/secure, and /var/log/messages), 노드(호스트) 로그
for node in $N1 $N2 $N3; do echo ">>>>> $node <<<<<"; \
ssh ec2-user@$node sudo tree /var/log/ -L 1; echo; done

// 노드 1에 dmesg, secure, messages 로그 확인
for log in dmesg secure messages; do echo ">>>>> Node1: /var/log/$log <<<<<"; \
ssh ec2-user@$N1 sudo tail /var/log/$log; echo; done
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **Dataplane 로그 소스** </span>
{% highlight javascript linenos %}
// dataplane 로그 소스(/var/log/journal for kubelet.service, kubeproxy.service, and docker.service), 쿠버네티스 데이터플레인 로그
for node in $N1 $N2 $N3; do echo ">>>>> $node <<<<<"; \
ssh ec2-user@$node sudo tree /var/log/journal -L 1; echo; done

// journal 로그 확인 (kubelet 정보)
ssh ec2-user@$N3 sudo journalctl -u kubelet -x -n 200

ssh ec2-user@$N3 sudo journalctl -u kubelet -f
{% endhighlight %}

<br/>

### 3.2. 그라파나 대시보드 사용

<br/>

<span style='color:white; background-color:#404040'> **네임 스페이스 생성** </span>

{% highlight javascript linenos %}
// 네임스페이스 생성
kubectl apply -f https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/cloudwatch-namespace.yaml

// 네임스페이스 확인
kubectl get ns
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **FluentBit ConfigMap 생성** </span>

{% highlight javascript linenos %}
// Fluent-bit ConfigMap 생성
FluentBitHttpServer='On'
FluentBitHttpPort='2020'
FluentBitReadFromHead='Off'
FluentBitReadFromTail='On'

kubectl create configmap fluent-bit-cluster-info \
--from-literal=cluster.name=${CLUSTER_NAME} \
--from-literal=http.server=${FluentBitHttpServer} \
--from-literal=http.port=${FluentBitHttpPort} \
--from-literal=read.head=${FluentBitReadFromHead} \
--from-literal=read.tail=${FluentBitReadFromTail} \
--from-literal=logs.region=${AWS_DEFAULT_REGION} -n amazon-cloudwatch
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **FluentBit 생성** </span>

{% highlight javascript linenos %}
// Fluentbit 생성
kubectl apply -f https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/fluent-bit/fluent-bit.yaml

// 설치 확인
kubectl get ds,pod,cm,sa -n amazon-cloudwatch
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **FluentBit ConfigMap 확인** </span>

{% highlight javascript linenos %}
// FluentBit Configmap 확인
kubectl get cm fluent-bit-cluster-info -n amazon-cloudwatch -o yaml | yh

// FluentBit Configmap 상세 - 로그 INPUT/FILTER/OUTPUT 설정 확인
/// 설정 구성 : application-log.conf, dataplane-log.conf, fluent-bit.conf, host-log.conf, parsers.conf
kubectl describe cm fluent-bit-config -n amazon-cloudwatch
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **FluentBit DaemonSet 확인** </span>

{% highlight javascript linenos %}
// FluentBit Daemonset 
/// 파드가 수집하는 방법 : Volumes에 HostPath 확인
kubectl describe ds fluent-bit -n amazon-cloudwatch

// /var/log에 tree 확인
ssh ec2-user@$N1 sudo tree /var/log
{% endhighlight %}


<br/>

---

<br/>

## 4. 애플리케이션 모니터링 설정 및 대시보드 추가

<br/>

### 4.1. NGINX 웹 서버 배포

<br/>

### 4.2. NGINX 모니터링 대시보드 추가

<br/>


### 4.3. 실습 자원 삭제

<br/>

<span style='color:white; background-color:#404040'> **실습 종료 후 자원 삭제** </span>

{% highlight javascript linenos %}
// fluent-bit 삭제
kubectl delete ds fluent-bit -n amazon-cloudwatch && kubectl delete cm fluent-bit-cluster-info -n amazon-cloudwatch && kubectl delete cm fluent-bit-config -n amazon-cloudwatch && kubectl delete sa fluent-bit -n amazon-cloudwatch

// bitnami nginx 삭제
helm uninstall nginx

// 로그 그룹 삭제 : 데이터 플레인
aws logs delete-log-group --log-group-name /aws/containerinsights/$CLUSTER_NAME/application
aws logs delete-log-group --log-group-name /aws/containerinsights/$CLUSTER_NAME/dataplane
aws logs delete-log-group --log-group-name /aws/containerinsights/$CLUSTER_NAME/host
aws logs delete-log-group --log-group-name /aws/containerinsights/$CLUSTER_NAME/performance
{% endhighlight %}

<br/>

{: .box-warning}
**Warning:** 다음 섹션의 실습을 이어서 진행할 것으로 Amazon EKS 원클릭 배포를 유지합니다. 혹시나 다음 섹션을 진행하지 않을 경우 4장 Amazon EKS 원클릭 배포를 삭제해 주길 바랍니다.

---

<br/>

여기까지 4장의 프로메테우스와 그라파나 구성하기 실습을 마칩니다.  
수고하셨습니다 :)

<br/><br/>
