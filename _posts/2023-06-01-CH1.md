---
layout: post
title: 1장 실습 Amazon EKS 배포
subtitle: Amazon EKS를 직접 배포하고 사용법을 알아봅니다.
tags: [books, test]
---
|목차|
|-----------|
|[1. 기본 인프라 배포](#1-기본-인프라-배포)|
|[2. 관리 콘솔에서 Amazon EKS 배포](#2-관리-콘솔에서-amazon-eks-배포)|
|3. IAM 생성|


<br/>


## 1. 기본 인프라 배포

<br/>

### 1.1. CloudFormation을 통한 기본 인프라 배포

[해당 링크](https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/new?stackName=myeks&templateURL=https:%2F%2Fs3.ap-northeast-2.amazonaws.com%2Fcloudformation.cloudneta.net%2FK8S%2Fmyeks-1week.yaml){:target="_blank"}를 클릭하면 AWS CloudFormation 페이지로 연결되며, 파라미터를 입력 후 스택을 실행합니다.

{: .box-note}
**Note:** AWS 관리 콘솔에 로그인 할때 루트 계정으로 진행합니다.

AWS CloudFormation에 의해 생성이 완료되면 관리 콘솔에서 생성된 인프라들을 확인합니다.

<br/>

### 1.2 EKS 관리용 인스턴스 정보 확인

생성된 EC2 인스턴스(`myeks-host`)에 SSH로 접속하고 아래 명령어를 통해 정보를 확인합니다.

<br/>

<span style='color:white; background-color:#404040'> **사용자 확인** </span>

{% highlight javascript linenos %}
whoami
{% endhighlight %}

- `whoami`를 입력하여 root 사용자임을 확인합니다.  
- ec2-user 사용자라면 실습의 편의를 위해 `sudo su -`를 입력하여 root 사용자로 전환합니다.

<br/>

<span style='color:white; background-color:#404040'> **기본 설치 도구 확인** </span>

{% highlight javascript linenos %}
// kubectl 버전 확인
kubectl version --client=true -o yaml | yh

// eksctl 버전 확인
eksctl version

// awscli 버전 확인
aws --version

// 도커 정보 확인
docker info
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **IAM 자격 증명** </span>  
{% highlight javascript linenos %}
// awscli로 인스턴스 정보 확인 (IAM 자격 증명 X)
aws ec2 describe-instances

// IAM 사용자 자격 구성
aws configure
{% endhighlight %}

- [링크](https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/id_root-user.html#id_root-user_manage_add-key){:target="_blank"}의 내용을 보고 루트 계정에서 엑세스 키를 생성합니다. 이때 `rootkey.csv`를 저장하고 해당 값을 참조합니다.
- `aws config`를 입력하여 Access Key ID, Secret Access Key, Region 코드를 입력한 후 IAM 자격 증명이 이루어지면 awscli 도구로 인스턴스 정보를 다시 확인합니다.

<br/>

<span style='color:white; background-color:#404040'> **EKS 배포할 VPC 정보 확인** </span>  
{% highlight javascript linenos %}
// EKS를 배포할 myeks-VPC 정보 확인
aws ec2 describe-vpcs --filters "Name=tag:Name,Values=$CLUSTER_NAME-VPC" | jq

// EKS를 배포할 myeks-VPC ID 값만 확인
aws ec2 describe-vpcs --filters "Name=tag:Name,Values=$CLUSTER_NAME-VPC" | jq -r .Vpcs[].VpcId
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **EKS 배포할 VPC ID 변수 저장** </span>  
{% highlight javascript linenos %}
// VPCID 변수에 myeks-VPC ID 값을 저장
export VPCID=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=$CLUSTER_NAME-VPC" | jq -r .Vpcs[].VpcId)

// VPCID를 전역 변수로 선언
echo "export VPCID=$VPCID" >> /etc/profile

// VPCID 변수 호출
echo $VPCID
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **EKS 배포할 VPC의 서브넷 정보 확인** </span>  
{% highlight javascript linenos %}
// EKS를 배포할 VPC의 전체 서브넷 정보 확인
aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPCID" --output json | jq

// EKS를 배포할 VPC의 퍼블릭 서브넷 정보 확인
aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet1" | jq
aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet2" | jq

// EKS를 배포할 VPC의 퍼블릭 서브넷 ID 값만 확인
aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet1" --query "Subnets[0].[SubnetId]" --output text
aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet2" --query "Subnets[0].[SubnetId]" --output text
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **EKS 배포할 퍼블릭 서브넷 ID 변수 저장** </span>  
{% highlight javascript linenos %}
// 변수에 퍼블릭 서브넷 ID 값을 저장
export PubSubnet1=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet1" --query "Subnets[0].[SubnetId]" --output text)
export PubSubnet2=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet2" --query "Subnets[0].[SubnetId]" --output text)

// 퍼블릭 서브넷 ID를 전역 변수로 선언
echo "export PubSubnet1=$PubSubnet1" >> /etc/profile
echo "export PubSubnet2=$PubSubnet2" >> /etc/profile

// VPCID 변수 호출
echo $PubSubnet1
echo $PubSubnet2
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **변수 호출 (종합)** </span>  
{% highlight javascript linenos %}  
echo $AWS_DEFAULT_REGION

echo $CLUSTER_NAME

echo $VPCID

echo $PubSubnet1,$PubSubnet2
{% endhighlight %}

<br/>



## 2. 관리 콘솔에서 Amazon EKS 배포

<br/>

### 2.1. Amazon EKS 클러스터 생성 (관리 콘솔)

Amazon EKS 클러스터 생성에 앞서 IAM 역할이 필요합니다.  
먼저 EKS 클러스터 IAM 역할을 생성 후 다음 작업을 진행합니다.

<span style='color:white; background-color:#404040'> **[관리 콘솔] EKS 클러스터 IAM Role 생성** </span>

- [AWS IAM 역할 메뉴](https://us-east-1.console.aws.amazon.com/iamv2/home?region=ap-northeast-2#/roles)로 진입합니다.
- `역할 만들기` 버튼을 클릭합니다.
- <U>신뢰할 수 있는 엔터티 유형</U>은 [AWS 서비스]로 선택합니다.
- 사용 사례는 <U>다른 AWS 서비스의 사용 사례</U>에서 [EKS] 선택 후 [EKS - Cluster]를 선택하고 `다음` 버튼을 클릭합니다.
- 연결되는 정책인 <U>AmazonEKSClusterPolicy</U>를 확인하고 `다음` 버튼을 클릭합니다.
- <U>역할 이름</U>을 *eksClusterRole*로 입력하고 `역할 생성` 버튼을 클릭합니다.


<br/>

<span style='color:white; background-color:#404040'> **[관리 콘솔] EKS 클러스터 추가 생성** </span>

- [Amazon EKS 관리 콘솔](https://ap-northeast-2.console.aws.amazon.com/eks/home?region=ap-northeast-2#/home)에 접속하여 `클러스터 추가` 버튼을 클릭하고 [생성]을 선택합니다.
- [클러스터 구성] 영역에서 <U>이름</U>은 *myeks*로 입력합니다.
- [클러스터 구성] 영역에서 <U>Kubernetes 버전</U>은 [1.24]로 선택합니다.
- [클러스터 구성] 영역에서 <U>클러스터 서비스 역할</U>은 [eksClusterRole]을 선택하고 `다음` 버튼을 클릭합니다.
- [네트워킹] 영역에서 <U>VPC</U>는 [myeks-VPC]를 선택합니다.
- [네트워킹] 영역에서 <U>서브넷</U>은 [myeks-PublicSubnet1]과 [myeks-PublicSubnet2]를 선택합니다.
- [클러스터 엔드포인트 엑세스] 영역에서 [퍼블릭]을 선택하고 `다음` 버튼을 클릭합니다.
- [로깅 구성] 영역은 별도의 설정 없이 `다음` 버튼을 클릭합니다.
- [추가 기능 선택] 영역은 기본값을 유지하고 `다음` 버튼을 클릭합니다.
- [선택한 추가 기능 설정 구성] 영역은 별도의 설정 없이 `다음` 버튼을 클릭합니다.
- [검토 및 생성] 영역의 내용을 살펴보고 `생성` 버튼을 클릭합니다.

{: .box-note}
**Note:** 설정을 마치고 약 6분 정도 대기 시간이 흐른 뒤 EKS 클러스터 생성이 완료됩니다.

<br/>

<span style='color:white; background-color:#404040'> **EKS 클러스터 정보를 kubeconfig 등록** </span>  
myeks-host에서 생성한 EKS 클러스터와 통신을 위해 kubeconfig 생성 및 업데이트가 필요합니다.  
{% highlight javascript linenos %}  
// EKS 클러스터 정보 업데이트
aws eks update-kubeconfig --region $AWS_DEFAULT_REGION --name $CLUSTER_NAME

// 생성한 Kubernetes 서비스 확인
kubectl get svc
{% endhighlight %}

<br/>

### 2.2. Amazon EKS 노드 생성 (관리 콘솔)

Amazon EKS 노드 생성에 앞서 IAM 역할이 필요합니다.  
먼저 EKS 노드 IAM 역할을 생성 후 다음 작업을 진행할 것인데 이번에는 ~~관리 콘솔~~이 아닌 awscli를 통해 작업을 진행하겠습니다.

<span style='color:white; background-color:#404040'> **EKS 노드 IAM Role의 신뢰 엔터티 설정** </span>

{% highlight javascript linenos %}
// EKS 노드 IAM 역할의 신뢰 대상 지정 파일 생성
cat <<EOT > node-role-trust-policy.json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOT
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **EKS 노드 IAM Role 생성** </span>

{% highlight javascript linenos %}
// EKS 노드 IAM 역할 생성 (eksNodeRole)
aws iam create-role \
  --role-name eksNodeRole \
  --assume-role-policy-document file://"node-role-trust-policy.json"

// EKS 노드 IAM 역할에 정책 연결
aws iam attach-role-policy \
  --policy-arn arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy \
  --role-name eksNodeRole

aws iam attach-role-policy \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly \
  --role-name eksNodeRole

aws iam attach-role-policy \
  --policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy \
  --role-name eksNodeRole
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **EKS 노드 IAM Role 확인** </span>

{% highlight javascript linenos %}
// EKS 노드 IAM 역할 확인
aws iam get-role --role-name eksNodeRole | jq

// EKS 노드 IAM 역할에 연결된 정책 확인
aws iam list-attached-role-policies --role-name eksNodeRole | jq
{% endhighlight %}

<br/>

