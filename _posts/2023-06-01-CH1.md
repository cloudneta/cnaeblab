---
layout: post
title: 1장 실습 Amazon EKS 배포
subtitle: Amazon EKS를 직접 배포하고 사용법을 알아봅니다.
tags: [books, test]
---
|목차|
|-----------|
|[1. 기본 인프라 배포](#1-기본-인프라-배포)|
|[2. 관리 콘솔에서 Amazon EKS 배포](#2-관리-콘솔에서-amazon-eks-배포)|
|3. IAM 생성|


<br/>


## 1. 기본 인프라 배포

<br/>

### 1) CloudFormation을 통한 기본 인프라 배포

[해당 링크](https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/new?stackName=myeks&templateURL=https:%2F%2Fs3.ap-northeast-2.amazonaws.com%2Fcloudformation.cloudneta.net%2FK8S%2Fmyeks-1week.yaml){:target="_blank"}를 클릭하면 AWS CloudFormation 페이지로 연결되며, 파라미터를 입력 후 스택을 실행합니다.

{: .box-note}
**Note:** AWS 관리 콘솔에 로그인 할때 루트 계정으로 진행합니다.

AWS CloudFormation에 의해 생성이 완료되면 관리 콘솔에서 생성된 인프라들을 확인합니다.

<br/>

### 2) EKS 관리용 인스턴스 정보 확인

생성된 EC2 인스턴스(`myeks-host`)에 SSH로 접속하고 아래 명령어를 통해 정보를 확인합니다.

<br/>

<span style='color:white; background-color:#404040'> **사용자 확인** </span>

{% highlight javascript linenos %}
whoami
{% endhighlight %}

- `whoami`를 입력하여 root 사용자임을 확인합니다.  
- ec2-user 사용자라면 실습의 편의를 위해 `sudo su -`를 입력하여 root 사용자로 전환합니다.

<br/>

<span style='color:white; background-color:#404040'> **기본 설치 도구 확인** </span>

{% highlight javascript linenos %}
// kubectl 버전 확인
kubectl version --client=true -o yaml | yh

// eksctl 버전 확인
eksctl version

// awscli 버전 확인
aws --version

// 도커 정보 확인
docker info
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **IAM 자격 증명** </span>  
{% highlight javascript linenos %}
// awscli로 인스턴스 정보 확인 (IAM 자격 증명 X)
aws ec2 describe-instances

// IAM 사용자 자격 구성
aws configure
{% endhighlight %}

- [링크](https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/id_root-user.html#id_root-user_manage_add-key){:target="_blank"}를 통해 루트 계정에서 엑세스 키를 생성하고 `rootkey.csv`를 저장하고 값을 참조합니다.
- `aws config`를 입력하여 Access Key ID, Secret Access Key, Region 코드를 입력한 후 IAM 자격 증명이 이루어지면 awscli로 인스턴스 정보를 다시 확인합니다.

<br/>

<span style='color:white; background-color:#404040'> **EKS 배포할 VPC 정보 확인** </span>  
{% highlight javascript linenos %}
// EKS를 배포할 myeks-VPC 정보 확인
aws ec2 describe-vpcs --filters "Name=tag:Name,Values=$CLUSTER_NAME-VPC" | jq

// EKS를 배포할 myeks-VPC ID 값만 확인
aws ec2 describe-vpcs --filters "Name=tag:Name,Values=$CLUSTER_NAME-VPC" | jq -r .Vpcs[].VpcId
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **EKS 배포할 VPC ID 변수 저장** </span>  
{% highlight javascript linenos %}
// VPCID 변수에 myeks-VPC ID 값을 저장
export VPCID=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=$CLUSTER_NAME-VPC" | jq -r .Vpcs[].VpcId)

// VPCID를 전역 변수로 선언
echo "export VPCID=$VPCID" >> /etc/profile

// VPCID 변수 호출
echo $VPCID
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **EKS 배포할 VPC의 서브넷 정보 확인** </span>  
{% highlight javascript linenos %}
// EKS를 배포할 VPC의 전체 서브넷 정보 확인
aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPCID" --output json | jq

// EKS를 배포할 VPC의 퍼블릭 서브넷 정보 확인
aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet1" | jq
aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet2" | jq

// EKS를 배포할 VPC의 퍼블릭 서브넷 ID 값만 확인
aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet1" --query "Subnets[0].[SubnetId]" --output text
aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet2" --query "Subnets[0].[SubnetId]" --output text
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **EKS 배포할 퍼블릭 서브넷 ID 변수 저장** </span>  
{% highlight javascript linenos %}
// 변수에 퍼블릭 서브넷 ID 값을 저장
export PubSubnet1=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet1" --query "Subnets[0].[SubnetId]" --output text)
export PubSubnet2=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-PublicSubnet2" --query "Subnets[0].[SubnetId]" --output text)

// 퍼블릭 서브넷 ID를 전역 변수로 선언
echo "export PubSubnet1=$PubSubnet1" >> /etc/profile
echo "export PubSubnet2=$PubSubnet2" >> /etc/profile

// VPCID 변수 호출
echo $PubSubnet1
echo $PubSubnet2
{% endhighlight %}

<br/>

<span style='color:white; background-color:#404040'> **변수 호출** </span>  
{% highlight javascript linenos %}
echo $AWS_DEFAULT_REGION

echo $CLUSTER_NAME

echo $VPCID

echo $PubSubnet1,$PubSubnet2
{% endhighlight %}

<br/>



## 2. 관리 콘솔에서 Amazon EKS 배포
